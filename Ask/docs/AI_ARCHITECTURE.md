# AI ë¶„ì„ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

HeartBridge Askì˜ 2ë‹¨ê³„ AI ë¶„ì„ ì‹œìŠ¤í…œ ì„¤ê³„ ë¬¸ì„œì…ë‹ˆë‹¤.

---

## ê°œìš”

### í•µì‹¬ ì»¨ì…‰
**2ë‹¨ê³„ AI íŒŒì´í”„ë¼ì¸**: ì „ë¬¸ê°€ ë¶„ì„ â†’ ë§ˆë¦¬ í˜ë¥´ì†Œë‚˜ ë³€í™˜

1. **1ì°¨ AI**: ê°ê´€ì ì´ê³  ì „ë¬¸ì ì¸ í–‰ë™ ë¶„ì„ (êµ¬ì¡°í™”ëœ JSON ì¶œë ¥)
2. **2ì°¨ AI**: 1ì°¨ ê²°ê³¼ë¥¼ ë§ˆë¦¬ì˜ ë”°ëœ»í•œ ëŒ€í™”ì²´ë¡œ ë³€í™˜ (ì‚¬ìš©ì ì¹œí™”ì  Markdown)

### ì™œ 2ë‹¨ê³„ì¸ê°€?
- **ë¶„ë¦¬ì˜ ì›ì¹™**: ë¶„ì„(ì „ë¬¸ì„±)ê³¼ í‘œí˜„(ì¹œê·¼í•¨)ì„ ëª…í™•íˆ ë¶„ë¦¬
- **ì•ˆì •ì„±**: JSON êµ¬ì¡°í™”ë¡œ íŒŒì‹± ì•ˆì •ì„± í™•ë³´
- **í™•ì¥ì„±**: ë‹¤ë¥¸ í˜ë¥´ì†Œë‚˜ë¡œ ì‰½ê²Œ êµì²´ ê°€ëŠ¥
- **ë””ë²„ê¹…**: 1ì°¨ ê²°ê³¼ë¥¼ ë¡œê¹…/ë¶„ì„ ê°€ëŠ¥

---

## ì „ì²´ ë°ì´í„° í”Œë¡œìš°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ì‚¬ìš©ì ì…ë ¥ (app.py)                                 â”‚
â”‚                                                      â”‚
â”‚  st.session_state = {                               â”‚
â”‚    responses: {                                      â”‚
â”‚      dog_name: "ì½”ì½”",                               â”‚
â”‚      dog_age: "2ì‚´",                                 â”‚
â”‚      main_concerns: ["ì§–ìŒ", "ì‚°ì±… ê³µê²©ì„±"],         â”‚
â”‚      problem_situation: "ë‚¯ì„  ê°œ ë§Œë‚¬ì„ ë•Œ",         â”‚
â”‚      hardest_part: "ì‚°ì±…ì´ ì–´ë ¤ì›Œìš”",               â”‚
â”‚      ... (20+ í•­ëª©)                                  â”‚
â”‚    },                                                â”‚
â”‚    dog_photo: <UploadedFile>,                       â”‚
â”‚    behavior_media: <UploadedFile> (ì„ íƒ)            â”‚
â”‚  }                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ prompt_builder.build_expert_analysis_prompt()       â”‚
â”‚                                                      â”‚
â”‚  ì…ë ¥: responses + dog_photo + behavior_media       â”‚
â”‚  ì¶œë ¥: {                                             â”‚
â”‚    system: EXPERT_PERSONA,                          â”‚
â”‚    user: "êµ¬ì¡°í™”ëœ ë¶„ì„ ìš”ì²­ í…ìŠ¤íŠ¸",               â”‚
â”‚    images: [dog_photo_base64, ...]                  â”‚
â”‚  }                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [1ì°¨ AI í˜¸ì¶œ] analyzer.call_claude_api()            â”‚
â”‚                                                      â”‚
â”‚  Model: Claude Sonnet 4.5                           â”‚
â”‚  System: EXPERT_PERSONA                             â”‚
â”‚  User: êµ¬ì¡°í™”ëœ ë¶„ì„ ìš”ì²­ + ì´ë¯¸ì§€ (Vision)         â”‚
â”‚                                                      â”‚
â”‚  ì¶œë ¥ (raw_analysis_json):                          â”‚
â”‚  {                                                   â”‚
â”‚    "analysis_summary": {                            â”‚
â”‚      "core_issue": "ê²½ê³„ì„± ì§–ìŒ",                   â”‚
â”‚      "root_cause": "ìƒˆë¡œìš´ ìê·¹ì— ëŒ€í•œ ë¶ˆì•ˆ",       â”‚
â”‚      "key_characteristics": [...]                   â”‚
â”‚    },                                                â”‚
â”‚    "solutions_best_fit": [                          â”‚
â”‚      {                                               â”‚
â”‚        "title": "ê±°ë¦¬ë‘ê¸° ì—°ìŠµ",                    â”‚
â”‚        "content": "...",                             â”‚
â”‚        "details": [...],                             â”‚
â”‚        "expected_outcome": "..."                     â”‚
â”‚      },                                               â”‚
â”‚      {...},  # ì´ 3ê°œ ê³ ì •                          â”‚
â”‚      {...}                                           â”‚
â”‚    ],                                                â”‚
â”‚    "future_guidance": [                             â”‚
â”‚      {                                               â”‚
â”‚        "principle": "ì¼ê´€ì„±ê³¼ ê¾¸ì¤€í•¨",              â”‚
â”‚        "content": "...",                             â”‚
â”‚        "action": "..."                               â”‚
â”‚      },                                               â”‚
â”‚      {...},  # ì´ 3ê°œ ê³ ì •                          â”‚
â”‚      {...}                                           â”‚
â”‚    ],                                                â”‚
â”‚    "core_message": "í›ˆë ¨ì€ ì–µëˆ„ë¥´ëŠ” ê²Œ ì•„ë‹ˆë¼...",  â”‚
â”‚    "confidence_score": 0.85                          â”‚
â”‚  }                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â†“ JSON íŒŒì‹± ë° ê²€ì¦
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ prompt_builder.build_mari_conversion_prompt()       â”‚
â”‚                                                      â”‚
â”‚  ì…ë ¥:                                               â”‚
â”‚    - raw_analysis_json (1ì°¨ ê²°ê³¼)                   â”‚
â”‚    - dog_name: "ì½”ì½”"                               â”‚
â”‚    - dog_age: "2ì‚´"                                 â”‚
â”‚    - hardest_part: "ì‚°ì±…ì´ ì–´ë ¤ì›Œìš”"                â”‚
â”‚                                                      â”‚
â”‚  ì¶œë ¥: {                                             â”‚
â”‚    system: MARI_PERSONA,                            â”‚
â”‚    user: MARI_CONVERSION_TEMPLATE.format(...)       â”‚
â”‚  }                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [2ì°¨ AI í˜¸ì¶œ] analyzer.call_claude_api()            â”‚
â”‚                                                      â”‚
â”‚  Model: Claude Sonnet 4.5                           â”‚
â”‚  System: MARI_PERSONA                               â”‚
â”‚  User: "1ì°¨ ê²°ê³¼ë¥¼ ë§ˆë¦¬ì²´ë¡œ ë³€í™˜í•´ì£¼ì„¸ìš”"           â”‚
â”‚                                                      â”‚
â”‚  ì¶œë ¥ (final_markdown):                             â”‚
â”‚  """                                                 â”‚
â”‚  **"ì½”ì½”(2ì‚´)ì˜ í–‰ë™ ë¶„ì„ ê²°ê³¼ì˜ˆìš”!"**             â”‚
â”‚                                                      â”‚
â”‚  "ì½”ì½”ëŠ” ì„¸ìƒì— ëŒ€í•œ í˜¸ê¸°ì‹¬ì´ ê°€ë“í•˜ì§€ë§Œ,           â”‚
â”‚  ì•„ì§ ë¯¸ì„±ìˆ™í•œ ê±°ë¦„ì„ ì¡°ì ˆìŠ¤ì¼€..."                  â”‚
â”‚                                                      â”‚
â”‚  ì½”ì½”ëŠ” í™œë°œí•˜ê³  í˜¸ê¸°ì‹¬ì´ ë§ì€ ì„±ê²©ì´ì—ìš”.          â”‚
â”‚  í•˜ì§€ë§Œ ë‚¯ì„  ì‚¬ëŒì´ë‚˜ ê°•ì•„ì§€ë¥¼ ë§ˆì£¼ì¹  ë•Œ...        â”‚
â”‚                                                      â”‚
â”‚  ğŸ¾ **ì´ëŸ° ì†”ë£¨ì…˜ì´ ì½”ì½”ì—ê²Œ ê°€ì¥ ì˜ ë§ì•„ìš”!**     â”‚
â”‚                                                      â”‚
â”‚  **1. ê±°ë¦¬ë‘ê¸° ì—°ìŠµë¶€í„° ì‹œì‘í•´ìš”.**                â”‚
â”‚  [êµ¬ì²´ì  ë°©ë²•...]                                    â”‚
â”‚                                                      â”‚
â”‚  **2. ì‹œì„  ì „í™˜ í›ˆë ¨ì„ í•´ë³´ì„¸ìš”.**                  â”‚
â”‚  [êµ¬ì²´ì  ë°©ë²•...]                                    â”‚
â”‚                                                      â”‚
â”‚  **3. ì‚¬íšŒí™”ëŠ” ì²œì²œíˆ, ë‹¨ê³„ì ìœ¼ë¡œ.**               â”‚
â”‚  [êµ¬ì²´ì  ë°©ë²•...]                                    â”‚
â”‚                                                      â”‚
â”‚  "í›ˆë ¨ì˜ ëª©í‘œëŠ” 'ì–µëˆ„ë¥´ëŠ” ê²ƒ'ì´ ì•„ë‹ˆë¼..."         â”‚
â”‚                                                      â”‚
â”‚  ğŸ¾ **ì•ìœ¼ë¡œ ì´ë ‡ê²Œ í•´ë³´ì„¸ìš”!**                    â”‚
â”‚  [ê²©ë ¤ + ì‹¤ì²œ ê°€ì´ë“œ...]                            â”‚
â”‚                                                      â”‚
â”‚  **ì½”ì½”ëŠ” ì˜í•˜ê³  ìˆì–´ìš”. ë³´í˜¸ìë‹˜ë„ ë„ˆë¬´ ì˜í•˜ê³    â”‚
â”‚  ê³„ì„¸ìš” ğŸ’›**                                        â”‚
â”‚  """                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ê²°ê³¼ ì €ì¥ ë° í‘œì‹œ                                    â”‚
â”‚                                                      â”‚
â”‚  st.session_state.analysis_result = {               â”‚
â”‚    "final_text": final_markdown,                    â”‚
â”‚    "confidence_score": 0.85,                         â”‚
â”‚    "raw_json": raw_analysis_json  # ë””ë²„ê¹…/ë¡œê¹…ìš©   â”‚
â”‚  }                                                   â”‚
â”‚                                                      â”‚
â”‚  page_result()ì—ì„œ:                                 â”‚
â”‚    st.markdown(final_text) ë Œë”ë§                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 1ì°¨ AI: ì „ë¬¸ê°€ ë¶„ì„

### ì—­í• 
ê°ê´€ì ì´ê³  ì „ë¬¸ì ì¸ í–‰ë™ ë¶„ì„ ìˆ˜í–‰

### ì…ë ¥
```python
{
    "dog_info": {
        "name": "ì½”ì½”",
        "age": "2ì‚´",
        "breed": "í¬ë©”ë¼ë‹ˆì•ˆ",
        "gender": "male",
        "neutered": "yes"
    },
    "personality": {
        "traits": ["í™œë°œí•¨", "í˜¸ê¸°ì‹¬", "í†µì œ ì–´ë ¤ì›€"],
        "activity_time": "30ë¶„-1ì‹œê°„"
    },
    "problem": {
        "main_concerns": ["ì§–ìŒ", "ì‚°ì±… ê³µê²©ì„±"],
        "situation": "ë‚¯ì„  ê°œ ë§Œë‚¬ì„ ë•Œ",
        "hardest_part": "ì‚°ì±…ì´ ì–´ë ¤ì›Œìš”"
    },
    "environment": {
        "living": "ì•„íŒŒíŠ¸",
        "family": "2-3ì¸"
    },
    "images": [dog_photo, behavior_media]
}
```

### ì¶œë ¥ (JSON êµ¬ì¡°)
```json
{
    "analysis_summary": {
        "core_issue": "ë¬¸ì œì˜ í•µì‹¬ ì§„ë‹¨",
        "root_cause": "ê·¼ë³¸ ì›ì¸ ë¶„ì„",
        "key_characteristics": [
            "íŠ¹ì§• 1",
            "íŠ¹ì§• 2"
        ]
    },
    "solutions_best_fit": [
        {
            "title": "ì†”ë£¨ì…˜ ì œëª©",
            "content": "í•µì‹¬ ì„¤ëª…",
            "details": ["ìƒì„¸ ë°©ë²• 1", "ìƒì„¸ ë°©ë²• 2"],
            "expected_outcome": "ê¸°ëŒ€ íš¨ê³¼"
        }
        // ì´ 3ê°œ ê³ ì •
    ],
    "future_guidance": [
        {
            "principle": "í•µì‹¬ ì›ì¹™",
            "content": "ì„¤ëª…",
            "action": "êµ¬ì²´ì  í–‰ë™"
        }
        // ì´ 3ê°œ ê³ ì •
    ],
    "core_message": "í•µì‹¬ ë©”ì‹œì§€ 1ê°œ",
    "confidence_score": 0.85
}
```

### ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ (EXPERT_PERSONA)
```
ë‹¹ì‹ ì€ ë°˜ë ¤ê²¬ í–‰ë™ ì „ë¬¸ í›ˆë ¨ì‚¬ì…ë‹ˆë‹¤.

## ì—­í• 
- ë°˜ë ¤ê²¬ í–‰ë™ì„ ê°ê´€ì ìœ¼ë¡œ ë¶„ì„
- ê³¼í•™ì  ê·¼ê±° ê¸°ë°˜ ì†”ë£¨ì…˜ ì œì‹œ
- êµ¬ì¡°í™”ëœ JSON ë°ì´í„° ì¶œë ¥

## ë¶„ì„ ê¸°ì¤€
- ì´ë¯¸ì§€ ë¶„ì„: í’ˆì¢… íŠ¹ì„±, í‘œì •, ìì„¸ë¡œ ì„±ê²© íŒŒì•…
- ì„¤ë¬¸ ë¶„ì„: ë¬¸ì œì˜ ë¹ˆë„, ê°•ë„, ë§¥ë½ íŒŒì•…
- ì¢…í•© ì§„ë‹¨: ê·¼ë³¸ ì›ì¸ ë„ì¶œ

## ì¶œë ¥ ê·œì¹™
- ì†”ë£¨ì…˜ 3ê°œ ê³ ì •
- ë¯¸ë˜ ê°€ì´ë˜ìŠ¤ 3ê°œ ê³ ì •
- ê° í•­ëª©ì€ êµ¬ì²´ì  ìˆ˜ì¹˜ í¬í•¨ (ê±°ë¦¬ 3~5m, í•˜ë£¨ 5ë¶„ ë“±)
- ì‹ ë¢°ë„ ì ìˆ˜ëŠ” ì •ë³´ ì¶©ë¶„ì„± ê¸°ì¤€
```

### ì´ë¯¸ì§€ í™œìš©
- **í’ˆì¢… í™•ì¸**: ì„¤ë¬¸ ì‘ë‹µê³¼ ì‹¤ì œ í’ˆì¢… ì¼ì¹˜ ì—¬ë¶€
- **í‘œì • ë¶„ì„**: ê¸´ì¥ë„, ê²½ê³„ì‹¬, í¸ì•ˆí•¨ ì •ë„
- **ìì„¸ ë¶„ì„**: ê·€, ê¼¬ë¦¬ ìœ„ì¹˜ë¡œ ì‹¬ë¦¬ ìƒíƒœ íŒŒì•…
- **í–‰ë™ íŒ¨í„´**: behavior_mediaê°€ ìˆìœ¼ë©´ ë¬¸ì œ í–‰ë™ ì§ì ‘ ê´€ì°°

---

## 2ì°¨ AI: ë§ˆë¦¬ í˜ë¥´ì†Œë‚˜ ë³€í™˜

### ì—­í• 
1ì°¨ ì „ë¬¸ê°€ ë¶„ì„ì„ ì‚¬ìš©ì ì¹œí™”ì ì¸ ë§ˆë¦¬ì˜ í†¤ìœ¼ë¡œ ë³€í™˜

### ì…ë ¥
```python
{
    "raw_analysis": {...},  # 1ì°¨ AIì˜ JSON ì „ì²´
    "dog_name": "ì½”ì½”",
    "dog_age": "2ì‚´",
    "hardest_part": "ì‚°ì±…ì´ ì–´ë ¤ì›Œìš”"
}
```

### ì¶œë ¥ (Markdown í…ìŠ¤íŠ¸)
```markdown
**"ì½”ì½”(2ì‚´)ì˜ í–‰ë™ ë¶„ì„ ê²°ê³¼ì˜ˆìš”!"**

"[key_characteristics ì¸ìš©]"

[ì„±ê²© ìš”ì•½ 2-3ë¬¸ì¥]

ì´ê±´ ì½”ì½”ê°€ [ê·¼ë³¸ ì›ì¸ í•´ì„] ğŸ¾

---

ğŸ¾ **ì´ëŸ° ì†”ë£¨ì…˜ì´ ì½”ì½”ì—ê²Œ ê°€ì¥ ì˜ ë§ì•„ìš”!**

**1. [ì œëª©]**
[ë§ˆë¦¬ì²´ë¡œ ë³€í™˜ëœ ë‚´ìš©]

**2. [ì œëª©]**
[ë§ˆë¦¬ì²´ë¡œ ë³€í™˜ëœ ë‚´ìš©]

**3. [ì œëª©]**
[ë§ˆë¦¬ì²´ë¡œ ë³€í™˜ëœ ë‚´ìš©]

"[core_message]"

---

ğŸ¾ **ì•ìœ¼ë¡œ ì´ë ‡ê²Œ í•´ë³´ì„¸ìš”!**

[future_guidanceë¥¼ ë§ˆë¦¬ì²´ë¡œ ìš”ì•½]

**ì½”ì½”ëŠ” ì˜í•˜ê³  ìˆì–´ìš”. ë³´í˜¸ìë‹˜ë„ ë„ˆë¬´ ì˜í•˜ê³  ê³„ì„¸ìš” ğŸ’›**
```

### ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ (MARI_PERSONA)
```
ë‹¹ì‹ ì€ 'ë§ˆë¦¬'ì…ë‹ˆë‹¤.

## ì •ì²´ì„±
- ë°˜ë ¤ê²¬ í–‰ë™ ì „ë¬¸ í›ˆë ¨ì‚¬ (10ë…„ ê²½ë ¥)
- ë”°ëœ»í•˜ê³  ì¹œê·¼í•œ ëŒ€í™”ì²´

## ì»¤ë®¤ë‹ˆì¼€ì´ì…˜ ìŠ¤íƒ€ì¼
- ë°˜ë§ ("~ì—ìš”", "~í•´ë³´ì„¸ìš”")
- ì´ëª¨ì§€ ìì—°ìŠ¤ëŸ½ê²Œ í™œìš© (ğŸ¾, ğŸ’¡, ğŸ’›)
- ì „ë¬¸ ìš©ì–´ëŠ” ì‰½ê²Œ í’€ì–´ì„œ ì„¤ëª…
- ê³µê°ê³¼ ê²©ë ¤ ìš°ì„ 

## ì›ì¹™
âœ… ì‹¤ì²œ ê°€ëŠ¥í•œ êµ¬ì²´ì  ë°©ë²•
âœ… ê¸ì • ê°•í™” í›ˆë ¨
âœ… ë”°ëœ»í•œ ê²©ë ¤

âŒ ì²´ë²Œ, ê°•ì••
âŒ ë³´í˜¸ì ë¹„ë‚œ
âŒ ì˜í•™ì  ì§„ë‹¨
```

### ë³€í™˜ ê·œì¹™
1. **1ì°¨ JSONì˜ êµ¬ì¡°ë¥¼ ìœ ì§€**í•˜ë˜ í†¤ë§Œ ë³€ê²½
2. **êµ¬ì²´ì  ìˆ˜ì¹˜ëŠ” ê·¸ëŒ€ë¡œ** ìœ ì§€ (3~5m, 5ë¶„ ë“±)
3. **ì´ëª¨ì§€ ì¶”ê°€**ë¡œ ì¹œê·¼í•¨ í‘œí˜„
4. **ê°•ì•„ì§€ ì´ë¦„ ë°˜ë³µ** ì‚¬ìš©ìœ¼ë¡œ ê°œì¸í™”
5. **ê²©ë ¤ ë©”ì‹œì§€** í•„ìˆ˜ í¬í•¨

---

## íŒŒì¼ êµ¬ì¡° ë° ì—­í• 

### `mari_persona.py`
```python
# 1ì°¨ AIìš© í˜ë¥´ì†Œë‚˜
EXPERT_PERSONA = """..."""

# 2ì°¨ AIìš© í˜ë¥´ì†Œë‚˜ (ê¸°ì¡´)
MARI_PERSONA = """..."""

# 2ì°¨ ë³€í™˜ í…œí”Œë¦¿
MARI_CONVERSION_TEMPLATE = """
ì•„ë˜ ì „ë¬¸ê°€ ë¶„ì„ì„ ë§ˆë¦¬ì˜ í†¤ìœ¼ë¡œ ë³€í™˜í•´ì£¼ì„¸ìš”:
{raw_analysis}

ê°•ì•„ì§€: {dog_name} ({dog_age})
ë³´í˜¸ì ê³ ë¯¼: {hardest_part}
"""
```

### `prompt_builder.py`
```python
def structure_survey_responses(responses: dict) -> dict:
    """ì„¤ë¬¸ ì‘ë‹µì„ êµ¬ì¡°í™”ëœ dictë¡œ ë³€í™˜"""

def build_expert_analysis_prompt(
    responses: dict,
    dog_photo: bytes,
    behavior_media: bytes = None
) -> dict:
    """1ì°¨ AIìš© í”„ë¡¬í”„íŠ¸ ìƒì„±"""

def build_mari_conversion_prompt(
    raw_json: dict,
    dog_name: str,
    dog_age: str,
    hardest_part: str
) -> dict:
    """2ì°¨ AIìš© í”„ë¡¬í”„íŠ¸ ìƒì„±"""
```

### `analyzer.py`
```python
async def call_claude_api(
    system: str,
    user: str,
    images: list = None,
    max_retries: int = 2
) -> str:
    """Claude API í˜¸ì¶œ (ì¬ì‹œë„ ë¡œì§ í¬í•¨)"""

def parse_json_response(response: str) -> dict:
    """JSON ì‘ë‹µ íŒŒì‹± ë° ê²€ì¦"""

async def analyze_two_stage(
    responses: dict,
    dog_photo: bytes,
    behavior_media: bytes = None
) -> dict:
    """2ë‹¨ê³„ AI ë¶„ì„ ì‹¤í–‰

    Returns:
        {
            "final_text": "ë§ˆë¦¬ì˜ ìµœì¢… Markdown",
            "confidence_score": 0.85,
            "raw_json": {...}  # ë””ë²„ê¹…/ë¡œê¹…ìš©
        }
    """
```

### `app.py` ìˆ˜ì • ì§€ì 
```python
# page_analyzing() (933-984ì¤„)
async def page_analyzing():
    # ...
    from src.ai.analyzer import analyze_two_stage

    result = await analyze_two_stage(
        responses=st.session_state.responses,
        dog_photo=st.session_state.dog_photo,
        behavior_media=st.session_state.behavior_media
    )

    st.session_state.analysis_result = result

# page_result() (988-1051ì¤„)
def page_result():
    result = st.session_state.analysis_result

    # ì‹ ë¢°ë„ ì ìˆ˜
    st.metric("ë¶„ì„ ì‹ ë¢°ë„", f"{result['confidence_score']*100:.0f}%")

    # ë§ˆë¦¬ì˜ ìµœì¢… ë‹µë³€ (Markdown ì „ì²´)
    st.markdown(result["final_text"])
```

---

## ì—ëŸ¬ í•¸ë“¤ë§ ì „ëµ

### 1ì°¨ AI ì‹¤íŒ¨ ì‹œ
```python
try:
    raw_json = await call_claude_api(expert_prompt)
except APIError as e:
    # ì¬ì‹œë„ (ìµœëŒ€ 2íšŒ)
    for retry in range(2):
        try:
            raw_json = await call_claude_api(expert_prompt)
            break
        except:
            if retry == 1:
                # ìµœì¢… ì‹¤íŒ¨ â†’ Mock ë°ì´í„° ì‚¬ìš©
                raw_json = get_mock_expert_analysis()
```

### 2ì°¨ AI ì‹¤íŒ¨ ì‹œ
```python
try:
    final_text = await call_claude_api(mari_prompt)
except APIError:
    # 1ì°¨ JSONì„ ê°„ë‹¨í•œ í…œí”Œë¦¿ìœ¼ë¡œ ë³€í™˜
    final_text = simple_template_conversion(raw_json)
```

### JSON íŒŒì‹± ì‹¤íŒ¨ ì‹œ
```python
try:
    result = json.loads(response)
    validate_required_fields(result)
except:
    # ì •ê·œì‹ìœ¼ë¡œ í•„ìˆ˜ í•„ë“œ ì¶”ì¶œ
    result = extract_with_regex(response)
```

---

## ì„±ëŠ¥ ìµœì í™”

### API í˜¸ì¶œ ìµœì í™”
- **1ì°¨ AI**: Sonnet 4.5 (ì •í™•ë„ ìš°ì„ )
- **2ì°¨ AI**: Sonnet 4.5 (í†¤ ì¼ê´€ì„± ìš°ì„ )
- í–¥í›„: 1ì°¨ëŠ” Haiku, 2ì°¨ëŠ” Sonnetìœ¼ë¡œ ë¶„ë¦¬ ê°€ëŠ¥

### ì‘ë‹µ ì‹œê°„
- 1ì°¨ AI: ì•½ 5-8ì´ˆ
- 2ì°¨ AI: ì•½ 3-5ì´ˆ
- **ì´ ì†Œìš” ì‹œê°„**: 8-13ì´ˆ

### ë¹„ìš©
- 1ì°¨ AI: ~2,000 í† í° (ì…ë ¥) + ~1,500 í† í° (ì¶œë ¥) = $0.03
- 2ì°¨ AI: ~1,500 í† í° (ì…ë ¥) + ~800 í† í° (ì¶œë ¥) = $0.02
- **1íšŒ ë¶„ì„ë‹¹**: $0.05

---

## í…ŒìŠ¤íŠ¸ ì „ëµ

### ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
```python
# test_prompt_builder.py
def test_structure_survey_responses()
def test_build_expert_prompt()
def test_build_mari_prompt()

# test_analyzer.py
def test_parse_json_response()
def test_validate_analysis_result()
```

### í†µí•© í…ŒìŠ¤íŠ¸
```python
# test_two_stage_analysis.py
async def test_full_pipeline():
    """ì „ì²´ 2ë‹¨ê³„ íŒŒì´í”„ë¼ì¸ í…ŒìŠ¤íŠ¸"""
    responses = EXAMPLE_RESPONSES
    result = await analyze_two_stage(responses, dog_photo)

    assert "final_text" in result
    assert "confidence_score" in result
    assert 0.0 <= result["confidence_score"] <= 1.0
```

### Mock í…ŒìŠ¤íŠ¸
```python
# API í˜¸ì¶œ ì—†ì´ ë¡œì§ë§Œ í…ŒìŠ¤íŠ¸
@patch('src.ai.analyzer.call_claude_api')
async def test_with_mock(mock_api):
    mock_api.return_value = MOCK_JSON_RESPONSE
    result = await analyze_two_stage(...)
```

---

## ë¡œê¹… ë° ëª¨ë‹ˆí„°ë§

### ë¡œê¹… í•­ëª©
```python
logger.info("1ì°¨ AI ë¶„ì„ ì‹œì‘", extra={
    "user_id": user_id,
    "dog_name": dog_name,
    "main_concerns": main_concerns
})

logger.info("1ì°¨ AI ì™„ë£Œ", extra={
    "confidence_score": raw_json["confidence_score"],
    "duration": duration,
    "tokens_used": tokens
})

logger.info("2ì°¨ AI ì™„ë£Œ", extra={
    "final_length": len(final_text),
    "total_duration": total_duration
})
```

### ëª¨ë‹ˆí„°ë§ ì§€í‘œ
- í‰ê·  ì‘ë‹µ ì‹œê°„
- API ì‹¤íŒ¨ìœ¨
- ì¬ì‹œë„ ë¹„ìœ¨
- ì‹ ë¢°ë„ ì ìˆ˜ ë¶„í¬
- ë¹„ìš© ì¶”ì´

---

## í–¥í›„ í™•ì¥

### RAG í†µí•© (ë‹¨ê¸°)
```python
# 1ì°¨ AI í”„ë¡¬í”„íŠ¸ì— ì „ë¬¸ê°€ ì§€ì‹ ì¶”ê°€
knowledge_context = rag_search(main_concerns)
expert_prompt += f"\n\n## ì°¸ê³  ìë£Œ\n{knowledge_context}"
```

### ë©€í‹°ëª¨ë‹¬ í™•ì¥ (ì¤‘ê¸°)
```python
# ë™ì˜ìƒ ë¶„ì„
video_frames = extract_key_frames(behavior_video)
expert_prompt["images"] = [dog_photo] + video_frames
```

### A/B í…ŒìŠ¤íŠ¸ (ì¥ê¸°)
```python
# ë‹¤ë¥¸ í˜ë¥´ì†Œë‚˜ ì‹¤í—˜
if user_group == "A":
    persona = MARI_PERSONA
else:
    persona = PROFESSIONAL_PERSONA  # ì „ë¬¸ì ì¸ í†¤
```

---

**ë¬¸ì„œ ë²„ì „**: 1.0
**ìµœì¢… ìˆ˜ì •ì¼**: 2025-01-26
**ì‘ì„±ì**: HeartBridge ê°œë°œíŒ€
